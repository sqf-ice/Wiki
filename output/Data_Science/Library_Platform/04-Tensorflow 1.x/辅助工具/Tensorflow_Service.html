<!DOCTYPE HTML>
<html>

<head>
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/Wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/Wiki/favicon.ico" type="image/x-icon">
    <title>TensorFlow Serving--模型服务部署 - Jun's personal knowledge wiki</title>
    <meta name="keywords" content="Technology, MachineLearning, DataMining, Wiki" />
    <meta name="description" content="A wiki website" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
            }
        });
    </script>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>
</head>

<body>

    <div id="container">
        
<div id="header">
  <div id="post-nav"><a href="/Wiki/">Home</a>&nbsp;»&nbsp;<a href="/Wiki/#Data_Science\Library_Platform\04-Tensorflow 1.x\辅助工具">Data_Science\Library_Platform\04-Tensorflow 1.x\辅助工具</a>&nbsp;»&nbsp;TensorFlow Serving--模型服务部署</div>
</div>
<div class="clearfix"></div>
<div id="title">TensorFlow Serving--模型服务部署</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#1-tensorflow_service">1. tensorflow_service 简介</a><ul>
<li><a href="#11">1.1. 功能</a><ul>
<li><a href="#_1">提供服务</a></li>
</ul>
</li>
<li><a href="#12">1.2. 架构</a></li>
<li><a href="#13">1.3. 概念</a><ul>
<li><a href="#131-core">1.3.1. Core 核心</a></li>
<li><a href="#132-manager">1.3.2. Manager 管理器</a></li>
<li><a href="#133-loader">1.3.3. Loader 加载器</a></li>
<li><a href="#134-sources">1.3.4. Sources 资源模块</a></li>
<li><a href="#135-models">1.3.5. Models 模型</a></li>
<li><a href="#136-servable">1.3.6. Servable 可服务类</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-tensorflow-service">2. tensorflow service运行前提</a><ul>
<li><a href="#21-tensorflow-service">2.1. 安装 tensorflow service</a></li>
<li><a href="#22-model">2.2. 准备~/model 中的模型文件</a><ul>
<li><a href="#221-signaturedefs">2.2.1. 用于服务的模型签名 SignatureDefs</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3">3. 服务器端模型上线运行</a><ul>
<li><a href="#31">3.1. [基础]运行</a></li>
<li><a href="#32">3.2. [进阶]配置</a><ul>
<li><a href="#321">3.2.1. 多模型配置</a></li>
<li><a href="#322">3.2.2. 版本策略</a></li>
<li><a href="#323">3.2.3. 批量处理</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-restful-api4">4. 客户端请求 RESTful API4</a><ul>
<li><a href="#41-api">4.1. 模型状态 API</a><ul>
<li><a href="#411-url">4.1.1. URL</a></li>
<li><a href="#412">4.1.2. 返回格式</a></li>
</ul>
</li>
<li><a href="#42-metadata-api">4.2. 模型元数据Metadata API</a><ul>
<li><a href="#421-url">4.2.1. URL</a></li>
<li><a href="#422">4.2.2. 返回格式</a></li>
</ul>
</li>
<li><a href="#43-api">4.3. 分类及回归问题 API</a><ul>
<li><a href="#431-url">4.3.1. URL</a></li>
<li><a href="#432">4.3.2. 请求格式</a></li>
<li><a href="#433">4.3.3. 返回格式</a></li>
</ul>
</li>
<li><a href="#44-predict-api">4.4. 预测 Predict API</a><ul>
<li><a href="#441-url">4.4.1. URL</a></li>
<li><a href="#442">4.4.2. 请求格式</a></li>
<li><a href="#443">4.4.3. 返回格式</a></li>
</ul>
</li>
<li><a href="#45-json">4.5. json 格式说明</a><ul>
<li><a href="#451">4.5.1. 输出二进制值的需求</a></li>
<li><a href="#452-json">4.5.2. JSON映射</a></li>
<li><a href="#454-json">4.5.4. JSON一致性</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5">5. 部署离线设备</a></li>
<li><a href="#7-simple_tensorflow_serving">7. [进阶] simple_tensorflow_serving 工具</a></li>
<li><a href="#8-savedmodel-cli-3">8. SavedModel CLI 命令概述3</a><ul>
<li><a href="#81-show">8.1. show 查看模型文件信息</a></li>
<li><a href="#82-run">8.2. run 运行</a></li>
</ul>
</li>
<li><a href="#9">9. 参考文献</a></li>
</ul>
</div>
<p>计算模型完成以后，需要对模型进行持久化保存，并部署在服务上。Tensorflow 为模型的部署上线提供了以tensorflow_service为核心的解决方案<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></p>
<h1 id="1-tensorflow_service">1. tensorflow_service 简介</h1>
<p>TensorFlow Serving 是一个用于机器学习模型Serving的高性能开源库，它可以将训练好的机器学习模型部署到线上，使用gRPC/RESTful作为接口接受外部调用。</p>
<h2 id="11">1.1. 功能</h2>
<ol>
<li>统一管理一个模型服务器，利于让他人使用多个模型，</li>
<li>且可以动态更新模型（热更新）</li>
<li>模型也会常住在内存里面，加快结果输出，减少模型加载时间。</li>
</ol>
<h3 id="_1">提供服务</h3>
<p>目前，TensorFlow Serving有3个服务API：（1）分类、（2）预测和（3）回归。</p>
<p>每个签名定义关联一个RPC API。分类SignatureDef用于分类RPC API，预测SignatureDef用于RPC API等。</p>
<h2 id="12">1.2. 架构</h2>
<p>Client端会不断给Manager发送请求，Manager会根据版本管理策略管理模型更新，并将最新的模型计算结果返回给Client端</p>
<p><img alt="" src="../../../../../attach/images/2019-10-10-14-48-37.png" /></p>
<h2 id="13">1.3. 概念</h2>
<h3 id="131-core">1.3.1. Core 核心</h3>
<p>TensorFlow Serving <code>Core</code> 用于管理  Servable的生命周期和测量</p>
<h3 id="132-manager">1.3.2. Manager 管理器</h3>
<p><code>Manager</code> 处理TensorFlow模型的全周期过程（模型加载、服务提供、模型卸载、模型版本迭代）</p>
<h3 id="133-loader">1.3.3. Loader 加载器</h3>
<p>加载器<code>Loaders</code> 管理可服务类<code>servable</code>的生命周期</p>
<h3 id="134-sources">1.3.4. Sources 资源模块</h3>
<p><code>Sources</code>资源模块用于从多种类型的文件系统<code>file system</code>中发现和提供可服务类<code>Servables</code>。其过程可以由类似rpc等协议实现。</p>
<p>对于每个资源模块而言，它提供0+个可服务类流<code>servable streams</code>。对于每个可服务类流<code>servable streams</code>，资源模块为其提供1个加载器实例<code>Loader instance</code></p>
<h3 id="135-models">1.3.5. Models 模型</h3>
<p>TensorFlow Serving 将一个模型<code>Models</code>通过1个或多个<code>Servable</code>可服务类 表示。</p>
<p>1个机器学习模型包括1个或多个算法（包括学习完成的权重）和嵌入表等。</p>
<h3 id="136-servable">1.3.6. Servable 可服务类</h3>
<p>Servable 可服务类是一个为客户端提供计算的对象。TensorFlow Serving 将一个模型通过1个或多个Servable 可服务类 表示。<br />
一个经典的servables 包括包括以下内容:</p>
<p>a TensorFlow SavedModelBundle (tensorflow::Session)<br />
a lookup table for embedding or vocabulary lookups</p>
<p>多个模型<code>Models</code>构成的组成模型可以以下方式表示：<br />
1. 多个独立的servables<br />
2. 1个组合的servables</p>
<p>1个 servables 同样可以只反应模型一部分</p>
<p>期望的版本<code>Aspired versions</code> 表示可用且准备好的可服务类 <code>Servable</code>版本</p>
<h1 id="2-tensorflow-service">2. tensorflow service运行前提</h1>
<h2 id="21-tensorflow-service">2.1. 安装 tensorflow service</h2>
<div class="hlcode"><pre><span class="cp"># 推荐 docker 安装 </span>
<span class="n">docker</span> <span class="n">pull</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">serving</span><span class="o">:</span><span class="n">latest</span><span class="o">-</span><span class="n">devel</span>

<span class="cp"># Linux</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">tensorflow</span><span class="o">-</span><span class="n">model</span><span class="o">-</span><span class="n">server</span>
</pre></div>


<h2 id="22-model">2.2. 准备<code>~/model</code> 中的模型文件</h2>
<p>必须有形如以下格式的文件夹作为模型存放地址。构建模型文件的方法<br />
参考 tf.saver </p>
<div class="hlcode"><pre><span class="o">~/</span><span class="n">export_dir</span>
<span class="o">|</span><span class="n">__assets</span><span class="o">/</span>
<span class="o">|</span><span class="n">__assets</span><span class="p">.</span><span class="n">extra</span><span class="o">/</span>
<span class="o">|</span><span class="n">__saved_model</span><span class="p">.</span><span class="n">pd</span>
<span class="o">|</span><span class="n">__variables</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">index</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
</pre></div>


<p>主要由以下及部分组成：</p>
<ol>
<li>
<p>SavedModel protocol buffe<br />
   ·  <code>saved_model.pb</code> or <code>saved_model.pbtxt</code><br />
   · 包括以 MetaGraphDef protocol buffers格式的图的定义。</p>
</li>
<li>
<p>Assets 资源<br />
   · 一个名为 <code>assets</code> 的子文件夹<br />
   · 包含 词汇表vocabularies 等辅助文件</p>
</li>
<li>额外资源 Extra assets<br />
   · 一个名为<code>Extra assets</code> 子文件夹<br />
   · 包括用户需要的自己的包或高级别的库，这些需求并没有在图中加载<br />
   · This subfolder is not managed by the SavedModel libraries.</li>
<li>变量<br />
   · 一个名为<code>variables</code> 的文件夹<br />
   · 包含 从TensorFlow Saver 得到的输出 包括：<ul>
<li>variables.data-?????-of-?????</li>
<li>variables.index</li>
</ul>
</li>
</ol>
<div class="hlcode"><pre><span class="n">MetaGraphDef</span> <span class="n">with</span> <span class="n">tag</span><span class="o">-</span><span class="n">set</span><span class="o">:</span> <span class="err">&#39;</span><span class="n">serve</span><span class="err">&#39;</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="n">SignatureDefs</span><span class="o">:</span>

<span class="n">signature_def</span><span class="p">[</span><span class="err">&#39;</span><span class="n">serving_default</span><span class="err">&#39;</span><span class="p">]</span><span class="o">:</span>
  <span class="n">The</span> <span class="n">given</span> <span class="n">SavedModel</span> <span class="n">SignatureDef</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="n">input</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">:</span>
    <span class="n">inputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">input_ids</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_INT64</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">ParseExample</span><span class="o">/</span><span class="n">ParseExample</span><span class="o">:</span><span class="mi">0</span>
    <span class="n">inputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">input_mask</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_INT64</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">ParseExample</span><span class="o">/</span><span class="n">ParseExample</span><span class="o">:</span><span class="mi">1</span>
    <span class="n">inputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">label_ids</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_INT64</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">ParseExample</span><span class="o">/</span><span class="n">ParseExample</span><span class="o">:</span><span class="mi">2</span>
    <span class="n">inputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">segment_ids</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_INT64</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">ParseExample</span><span class="o">/</span><span class="n">ParseExample</span><span class="o">:</span><span class="mi">3</span>
  <span class="n">The</span> <span class="n">given</span> <span class="n">SavedModel</span> <span class="n">SignatureDef</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="n">output</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">:</span>
    <span class="n">outputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">labels</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_INT32</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">loss</span><span class="o">/</span><span class="n">Squeeze</span><span class="o">:</span><span class="mi">0</span>
    <span class="n">outputs</span><span class="p">[</span><span class="err">&#39;</span><span class="n">probabilities</span><span class="err">&#39;</span><span class="p">]</span> <span class="n">tensor_info</span><span class="o">:</span>
        <span class="nl">dtype:</span> <span class="n">DT_FLOAT</span>
        <span class="nl">shape:</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nl">name:</span> <span class="n">loss</span><span class="o">/</span><span class="n">LogSoftmax</span><span class="o">:</span><span class="mi">0</span>
  <span class="n">Method</span> <span class="n">name</span> <span class="n">is</span><span class="o">:</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">serving</span><span class="o">/</span><span class="n">predict</span>
</pre></div>


<h3 id="221-signaturedefs">2.2.1. 用于服务的模型签名 SignatureDefs</h3>
<p><a href="https://www.tensorflow.org/tfx/serving/signature_defs">SignatureDefs in SavedModel for TensorFlow Serving</a></p>
<h1 id="3">3. 服务器端模型上线运行</h1>
<h2 id="31">3.1. [基础]运行</h2>
<p><strong>基于docker安装的运行</strong><br />
1. 进入docker 命令行</p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">it</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8500</span><span class="o">:</span><span class="mi">8500</span> <span class="o">--</span><span class="n">name</span> <span class="n">grpc_name</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">serving</span><span class="o">:</span><span class="n">latest</span><span class="o">-</span><span class="n">devel</span>

<span class="cp"># 8500端口：grpc的端口</span>
<span class="cp"># 8501端口：restful api的端口</span>
<span class="cp"># 上述命令直接进入docker 的命令行</span>
<span class="cp">#[docker]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">ls</span> 
</pre></div>


<ol>
<li>将模型部署到docker中</li>
</ol>
<p>将位于 <code>~/model</code>的文件复制到 名为 <code>grpc_name</code> docker 中的 <code>/online_model</code> 文件夹中 </p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">cp</span> <span class="o">~/</span><span class="n">model</span> <span class="n">grpc</span><span class="o">:/</span><span class="n">online_model</span>
</pre></div>


<p>其中 <code>~/model</code> 中的文件 形如:</p>
<div class="hlcode"><pre><span class="o">~/</span><span class="n">model</span>
<span class="o">|</span><span class="n">__assets</span><span class="o">/</span>
<span class="o">|</span><span class="n">__assets</span><span class="p">.</span><span class="n">extra</span><span class="o">/</span>
<span class="o">|</span><span class="n">__variables</span><span class="o">/</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">data</span><span class="o">-?????-</span><span class="n">of</span><span class="o">-?????</span>
    <span class="o">|</span><span class="n">__variables</span><span class="p">.</span><span class="n">index</span>
<span class="o">|</span><span class="n">__saved_model</span><span class="p">.</span><span class="n">pb</span>
</pre></div>


<ol>
<li>在服务端开启服务 </li>
</ol>
<div class="hlcode"><pre><span class="cp"># on [Docker]</span>
<span class="n">tensorflow_model_server</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">8500</span> <span class="o">--</span><span class="n">model_name</span><span class="o">=</span><span class="err">&#39;模型名称&#39;</span> <span class="o">--</span><span class="n">model_base_path</span><span class="o">=/</span><span class="n">online_model</span><span class="o">/</span><span class="n">builder</span><span class="o">/</span>
</pre></div>


<p><strong>基于Linux安装的运行</strong><br />
使用SavedModel CLI 命令开启服务</p>
<div class="hlcode"><pre><span class="err">$</span> <span class="n">tensorflow_model_server</span> <span class="o">--</span><span class="n">port</span><span class="o">=</span><span class="mi">9000</span> <span class="o">--</span><span class="n">model_name</span><span class="o">=</span><span class="err">&#39;模型名称&#39;</span>  <span class="o">--</span><span class="n">model_base_path</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mnist_model</span><span class="o">/</span>
</pre></div>


<h2 id="32">3.2. [进阶]配置</h2>
<h3 id="321">3.2.1. 多模型配置</h3>
<div class="hlcode"><pre><span class="p">.</span><span class="o">/</span><span class="n">export_model</span><span class="o">/</span>
<span class="o">|</span>
<span class="err">└──</span><span class="n">model_1</span>
    <span class="err">├──</span> <span class="n">version_1</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">assets</span>
    <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">variables</span>
    <span class="err">│</span>       <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
    <span class="err">│</span>       <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
    <span class="err">└──</span> <span class="n">version_2</span>
        <span class="err">├──</span> <span class="n">assets</span>
        <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
        <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
        <span class="err">└──</span> <span class="n">variables</span>
            <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
            <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
<span class="err">└──</span><span class="n">model_2</span>
    <span class="err">├──</span> <span class="n">version_1</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">assets</span>
    <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">variables</span>
    <span class="err">│</span>       <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
    <span class="err">│</span>       <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
    <span class="err">└──</span> <span class="n">version_2</span>
        <span class="err">├──</span> <span class="n">assets</span>
        <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
        <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
        <span class="err">└──</span> <span class="n">variables</span>
            <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
            <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
<span class="err">└──</span><span class="n">model_3</span>
    <span class="err">├──</span> <span class="n">version_1</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">assets</span>
    <span class="err">│</span>   <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
    <span class="err">│</span>   <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
    <span class="err">│</span>   <span class="err">└──</span> <span class="n">variables</span>
    <span class="err">│</span>       <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
    <span class="err">│</span>       <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
    <span class="err">└──</span> <span class="n">version_2</span>
        <span class="err">├──</span> <span class="n">assets</span>
        <span class="err">│</span>   <span class="err">└──</span> <span class="n">vocab</span><span class="p">.</span><span class="n">txt</span>
        <span class="err">├──</span> <span class="n">saved_model</span><span class="p">.</span><span class="n">pb</span>
        <span class="err">└──</span> <span class="n">variables</span>
            <span class="err">├──</span> <span class="n">variables</span><span class="p">.</span><span class="n">data</span><span class="o">-</span><span class="mo">00000</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="mo">00001</span>
            <span class="err">└──</span> <span class="n">variables</span><span class="p">.</span><span class="n">index</span>
</pre></div>


<p>在<code>/export_model/</code>文件夹下新建一个配置文件model.config，文件内容为：</p>
<div class="hlcode"><pre><span class="nl">model_config_list:</span><span class="p">{</span>
    <span class="nl">config:</span><span class="p">{</span>
      <span class="nl">name:</span><span class="s">&quot;model1&quot;</span><span class="p">,</span>
      <span class="nl">base_path:</span><span class="s">&quot;/models/multiModel/model1&quot;</span><span class="p">,</span>
      <span class="nl">model_platform:</span><span class="s">&quot;tensorflow&quot;</span>
    <span class="p">},</span>
    <span class="nl">config:</span><span class="p">{</span>
      <span class="nl">name:</span><span class="s">&quot;model2&quot;</span><span class="p">,</span>
      <span class="nl">base_path:</span><span class="s">&quot;/models/multiModel/model2&quot;</span><span class="p">,</span>
      <span class="nl">model_platform:</span><span class="s">&quot;tensorflow&quot;</span>
    <span class="p">},</span>
    <span class="nl">config:</span><span class="p">{</span>
      <span class="nl">name:</span><span class="s">&quot;model3&quot;</span><span class="p">,</span>
      <span class="nl">base_path:</span><span class="s">&quot;/models/multiModel/model3&quot;</span><span class="p">,</span>
      <span class="nl">model_platform:</span><span class="s">&quot;tensorflow&quot;</span>
    <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<p>配置文件定义了模型的名称和模型在容器内的路径，现在运行tfserving容器 :</p>
<div class="hlcode"><pre><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="mi">8501</span><span class="o">:</span><span class="mi">8501</span> <span class="o">--</span><span class="n">mount</span> <span class="n">type</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span><span class="n">source</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">jerry</span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">multiModel</span><span class="o">/</span><span class="p">,</span><span class="n">target</span><span class="o">=/</span><span class="n">models</span><span class="o">/</span><span class="n">multiModel</span> \
 <span class="o">-</span><span class="n">t</span> <span class="n">tensorflow</span><span class="o">/</span><span class="n">serving</span> <span class="o">--</span><span class="n">model_config_file</span><span class="o">=/</span><span class="n">models</span><span class="o">/</span><span class="n">multiModel</span><span class="o">/</span><span class="n">models</span><span class="p">.</span><span class="n">config</span>
</pre></div>


<p>请求预测：</p>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">requests</span> 
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span> 
<span class="n">SERVER_URL</span> <span class="o">=</span> <span class="s">&#39;http://localhost:8501/v1/models/model3:predict&#39;</span>  
<span class="c">#注意SERVER_URL中的‘model3’是config文件中定义的模型name,不是文件夹名称</span>

<span class="k">def</span> <span class="nf">prediction</span><span class="p">():</span> 
    <span class="n">predict_request</span><span class="o">=</span><span class="s">&#39;{&quot;instances&quot;:</span><span class="si">%s</span><span class="s">}&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">([[[</span><span class="mi">10</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">]</span><span class="o">*</span><span class="mi">7</span><span class="p">])</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">predict_request</span><span class="p">)</span> 
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">SERVER_URL</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">predict_request</span><span class="p">)</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="n">prediction</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s">&#39;predictions&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> 

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span> 
    <span class="n">prediction</span><span class="p">()</span>
</pre></div>


<h3 id="322">3.2.2. 版本策略</h3>
<p>如果一个模型有多个版本，并在预测的时候希望指定模型的版本，可以通过以下方式实现。<br />
修改model.config文件，增加model_version_policy：</p>
<div class="hlcode"><pre><span class="nx">model_config_list</span><span class="o">:</span><span class="p">{</span>
    <span class="nx">config</span><span class="o">:</span><span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span><span class="s2">&quot;model1&quot;</span><span class="p">,</span>
      <span class="nx">base_path</span><span class="o">:</span><span class="s2">&quot;/models/multiModel/model1&quot;</span><span class="p">,</span>
      <span class="nx">model_platform</span><span class="o">:</span><span class="s2">&quot;tensorflow&quot;</span><span class="p">,</span>
      <span class="nx">model_version_policy</span><span class="o">:</span><span class="p">{</span>
        <span class="nx">all</span><span class="o">:</span><span class="p">{}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">config</span><span class="o">:</span><span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span><span class="s2">&quot;model2&quot;</span><span class="p">,</span>
      <span class="nx">base_path</span><span class="o">:</span><span class="s2">&quot;/models/multiModel/model2&quot;</span><span class="p">,</span>
      <span class="nx">model_platform</span><span class="o">:</span><span class="s2">&quot;tensorflow&quot;</span>
    <span class="p">},</span>
    <span class="nx">config</span><span class="o">:</span><span class="p">{</span>
      <span class="nx">name</span><span class="o">:</span><span class="s2">&quot;model3&quot;</span><span class="p">,</span>
      <span class="nx">base_path</span><span class="o">:</span><span class="s2">&quot;/models/multiModel/model3&quot;</span><span class="p">,</span>
      <span class="nx">model_platform</span><span class="o">:</span><span class="s2">&quot;tensorflow&quot;</span>
    <span class="p">}</span> 
<span class="p">}</span>
</pre></div>


<h3 id="323">3.2.3. 批量处理</h3>
<p>Batching<br />
Another typical server feature we want in a production environment is batching. Modern hardware accelerators (GPUs, etc.) used to do machine learning inference usually achieve best computation efficiency when inference requests are run in large batches.</p>
<p>Batching can be turned on by providing proper SessionBundleConfig when creating the SavedModelBundleSourceAdapter. In this case we set the BatchingParameters with pretty much default values. Batching can be fine-tuned by setting custom timeout, batch_size, etc. values. For details, please refer to BatchingParameters.</p>
<p>SessionBundleConfig session_bundle_config;<br />
// Batching config<br />
if (enable_batching) {<br />
  BatchingParameters<em> batching_parameters =<br />
      session_bundle_config.mutable_batching_parameters();<br />
  batching_parameters-&gt;mutable_thread_pool_name()-&gt;set_value(<br />
      "model_server_batch_threads");<br />
}<br />
</em>saved_model_bundle_source_adapter_config.mutable_legacy_config() =<br />
    session_bundle_config;</p>
<p>Upon reaching full batch, inference requests are merged internally into a single large request (tensor), and tensorflow::Session::Run() is invoked (which is where the actual efficiency gain on GPUs comes from).</p>
<p>Batching Configuration<br />
Model Server has the ability to batch requests in a variety of settings in order to realize better throughput. The scheduling for this batching is done globally for all models and model versions on the server to ensure the best possible utilization of the underlying resources no matter how many models or model versions are currently being served by the server (more details). You may enable this behavior by setting the --enable_batching flag and control it by passing a config to the --batching_parameters_file flag.</p>
<p>Example batching parameters file:</p>
<p>max_batch_size { value: 128 }<br />
batch_timeout_micros { value: 0 }<br />
max_enqueued_batches { value: 1000000 }<br />
num_batch_threads { value: 8 }</p>
<p>Please refer to the batching guide for an in-depth discussion and refer to the section on parameters to understand how to set the parameters.</p>
<h1 id="4-restful-api4">4. 客户端请求 RESTful API<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">4</a></sup></h1>
<p>TensorFlow ModelServer 可以运行在 host:port 上并接受 REST API 请求：</p>
<div class="hlcode"><pre><span class="nx">POST</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//host:port/&lt;URI&gt;:&lt;VERB&gt;</span>
<span class="nx">URI</span><span class="p">:</span> <span class="p">/</span><span class="nx">v1</span><span class="p">/</span><span class="nx">models</span><span class="o">/</span><span class="err">$</span><span class="p">{</span><span class="nx">MODEL_NAME</span><span class="p">}</span><span class="err">[</span><span class="p">/</span><span class="nx">versions</span><span class="o">/</span><span class="err">$</span><span class="p">{</span><span class="nx">MODEL_VERSION</span><span class="p">}</span><span class="cp">]</span>
VERB: classify|regress|predict
/versions/${MODEL_VERSION} 为可选部分，如果省略的话则使用最新版本的模型。
</pre></div>


<p>请求 URLs 的示例如下：</p>
<div class="hlcode"><pre><span class="nl">http:</span><span class="c1">//host:port/v1/models/iris:classify</span>
<span class="nl">http:</span><span class="c1">//host:port/v1/models/模型名称/versions/模型版本号:predict</span>
</pre></div>


<p>请求和响应均为一个 JSON 对象，其内容取决于请求的类型和 VERB.</p>
<p>为了处理可能的错误，APIs 返回的 JSON 对象中包含了一个以 error 为键，<code>error</code> 错误信息返回json形式</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">error</span> <span class="nx">message</span> <span class="nx">string</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>


<h2 id="41-api">4.1. 模型状态 API</h2>
<h3 id="411-url">4.1.1. URL</h3>
<div class="hlcode"><pre>GET http://host:port/v1/models/<span class="cp">${</span><span class="n">MODEL_NAME</span><span class="cp">}</span>[/versions/<span class="cp">${</span><span class="n">MODEL_VERSION</span><span class="cp">}</span>]
</pre></div>


<p><code>/versions/${MODEL_VERSION}</code> is optional. If omitted status for all versions is<br />
returned in the response.</p>
<h3 id="412">4.1.2. 返回格式</h3>
<div class="hlcode"><pre><span class="p">{</span>
 <span class="nt">&quot;model_version_status&quot;</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">{</span>
   <span class="nt">&quot;version&quot;</span><span class="p">:</span> <span class="s2">&quot;1570601080&quot;</span><span class="p">,</span>
   <span class="nt">&quot;state&quot;</span><span class="p">:</span> <span class="s2">&quot;AVAILABLE&quot;</span><span class="p">,</span>
   <span class="nt">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;error_code&quot;</span><span class="p">:</span> <span class="s2">&quot;OK&quot;</span><span class="p">,</span>
    <span class="nt">&quot;error_message&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
   <span class="p">}</span>
  <span class="p">}</span>
 <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<h2 id="42-metadata-api">4.2. 模型元数据Metadata API</h2>
<h3 id="421-url">4.2.1. URL</h3>
<div class="hlcode"><pre>GET http://host:port/v1/models/<span class="cp">${</span><span class="n">MODEL_NAME</span><span class="cp">}</span>[/versions/<span class="cp">${</span><span class="n">MODEL_VERSION</span><span class="cp">}</span>]/metadata
</pre></div>


<p><code>/versions/${MODEL_VERSION}</code> is optional. If omitted the model metadata for<br />
the latest version is returned in the response.</p>
<h3 id="422">4.2.2. 返回格式</h3>
<h2 id="43-api">4.3. 分类及回归问题 API</h2>
<p>分类及回归问题与预测问题 区别<br />
分类 返回 label:string score:float<br />
回归 返回 value:float<br />
预测 返回 predictions:{}</p>
<h3 id="431-url">4.3.1. URL</h3>
<div class="hlcode"><pre>POST http://host:port/v1/models/<span class="cp">${</span><span class="n">MODEL_NAME</span><span class="cp">}</span>[/versions/<span class="cp">${</span><span class="n">MODEL_VERSION</span><span class="cp">}</span>]:(classify|regress)
</pre></div>


<p><code>/versions/${MODEL_VERSION}</code> is optional. If omitted the latest version is used.</p>
<h3 id="432">4.3.2. 请求格式</h3>
<p>分类或回归问题的请求格式相同</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="c1">// Optional: serving signature to use.</span>
  <span class="c1">// If unspecifed default serving signature is used.</span>
  <span class="s2">&quot;signature_name&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span>

  <span class="c1">// Optional: Common context shared by all examples.</span>
  <span class="c1">// Features that appear here MUST NOT appear in examples (below).</span>
  <span class="s2">&quot;context&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;&lt;feature_name3&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span>
    <span class="s2">&quot;&lt;feature_name4&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span>
  <span class="p">},</span>

  <span class="c1">// List of Example objects</span>
  <span class="s2">&quot;examples&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="c1">// Example 1</span>
      <span class="s2">&quot;&lt;feature_name1&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="s2">&quot;&lt;feature_name2&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="p">...</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="c1">// Example 2</span>
      <span class="s2">&quot;&lt;feature_name1&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="s2">&quot;&lt;feature_name2&gt;&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p><code>&lt;value&gt;</code> is a JSON number (whole or decimal) or string, and <code>&lt;list&gt;</code> is a list of such values. See <a href="#encoding-binary-values">Encoding binary values</a> section below for details on how to represent a binary (stream of bytes) value. </p>
<h3 id="433">4.3.3. 返回格式</h3>
<p><strong>分类问题</strong><br />
分类问题返回的是一个 label 列表，如下</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="c1">// List of class label/score pairs for first Example (in request)</span>
    <span class="p">[</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">label1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">score1</span><span class="o">&gt;</span><span class="p">],</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">label2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">score2</span><span class="o">&gt;</span><span class="p">],</span> <span class="p">...</span> <span class="p">],</span>

    <span class="c1">// List of class label/score pairs for next Example (in request)</span>
    <span class="p">[</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">label1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">score1</span><span class="o">&gt;</span><span class="p">],</span> <span class="p">[</span><span class="o">&lt;</span><span class="nx">label2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">score2</span><span class="o">&gt;</span><span class="p">],</span> <span class="p">...</span> <span class="p">],</span>
    <span class="p">...</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p><code>&lt;label&gt;</code> is a string (which can be an empty string <code>""</code> if the model does not have a label associated with the score).<br />
<code>&lt;score&gt;</code> is a decimal (floating point) number.</p>
<p><strong>回归问题</strong></p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="c1">// One regression value for each example in the request in the same order.</span>
  <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">[</span> <span class="o">&lt;</span><span class="nx">value1</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">value2</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="nx">value3</span><span class="o">&gt;</span><span class="p">,</span> <span class="p">...]</span>
<span class="p">}</span>
</pre></div>


<p><code>&lt;value&gt;</code> is a decimal number.</p>
<h2 id="44-predict-api">4.4. 预测 Predict API</h2>
<h3 id="441-url">4.4.1. URL</h3>
<div class="hlcode"><pre>POST http://host:port/v1/models/<span class="cp">${</span><span class="n">MODEL_NAME</span><span class="cp">}</span>[/versions/<span class="cp">${</span><span class="n">MODEL_VERSION</span><span class="cp">}</span>]:predict
</pre></div>


<p><code>/versions/${MODEL_VERSION}</code> is optional. If omitted the latest version is used.</p>
<h3 id="442">4.4.2. 请求格式</h3>
<p>predict API 的请求内容必须为如下格式的 JSON 对象：</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="c1">// (Optional) Serving signature to use.</span>
  <span class="c1">// If unspecifed default serving signature is used.</span>
  <span class="s2">&quot;signature_name&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">,</span>

  <span class="c1">// Input Tensors in row (&quot;instances&quot;) or columnar (&quot;inputs&quot;) format.</span>
  <span class="c1">// A request can have either of them but NOT both.</span>
  <span class="s2">&quot;instances&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="p">(</span><span class="nx">nested</span><span class="p">)</span><span class="nx">list</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">-</span><span class="nx">of</span><span class="o">-</span><span class="nx">objects</span><span class="o">&gt;</span>
  <span class="s2">&quot;inputs&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="p">(</span><span class="nx">nested</span><span class="p">)</span><span class="nx">list</span><span class="o">&gt;|&lt;</span><span class="nx">object</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>


<p>形如以下的数据（2个实例，3个命名空间）输入到模型中</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>signal</th>
<th>sensor</th>
</tr>
</thead>
<tbody>
<tr>
<td>"foo"</td>
<td>[1, 2, 3, 4, 5]</td>
<td>[[1, 2], [3, 4] ]</td>
</tr>
<tr>
<td>"bar"</td>
<td>[3, 4, 1, 2, 5]</td>
<td>[[4, 5], [6, 8] ]</td>
</tr>
</tbody>
</table>
<p><strong>按列输入</strong></p>
<div class="hlcode"><pre><span class="p">{</span>
 <span class="nt">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="nt">&quot;tag&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">],</span>
   <span class="nt">&quot;signal&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]],</span>
   <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="p">[[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]]</span>
 <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>按行输入(row format)</strong></p>
<div class="hlcode"><pre><span class="p">{</span>
 <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span>
   <span class="p">{</span>
     <span class="nt">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
     <span class="nt">&quot;signal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
     <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
   <span class="p">},</span>
   <span class="p">{</span>
     <span class="nt">&quot;tag&quot;</span><span class="p">:</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span>
     <span class="nt">&quot;signal&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span><span class="err">]</span><span class="p">,</span>
     <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">]]</span>
   <span class="p">}</span>
 <span class="p">]</span>
<span class="p">}</span>

<span class="err">//</span> <span class="mi">0</span><span class="err">维度数据</span> <span class="err">当只有一个命名输入</span>
<span class="p">{</span>
  <span class="err">//</span> <span class="err">List</span> <span class="err">of</span> <span class="err">3</span> <span class="err">scalar</span> <span class="err">tensors.</span>
  <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;baz&quot;</span> <span class="p">]</span>
<span class="p">}</span>

<span class="p">{</span>
  <span class="err">//</span> <span class="err">List</span> <span class="err">of</span> <span class="err">2</span> <span class="err">tensors</span> <span class="err">each</span> <span class="err">of</span> <span class="err">[1,</span> <span class="err">2]</span> <span class="err">shape</span>
  <span class="nt">&quot;instances&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span> <span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span> <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<h3 id="443">4.4.3. 返回格式</h3>
<p><strong>按行输入(row format)</strong></p>
<p><code>predict</code> 返回格式</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s2">&quot;predictions&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="p">(</span><span class="nx">nested</span><span class="p">)</span><span class="nx">list</span><span class="o">&gt;|&lt;</span><span class="nx">list</span><span class="o">-</span><span class="nx">of</span><span class="o">-</span><span class="nx">objects</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>


<p><strong>按列输入</strong></p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="s2">&quot;outputs&quot;</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">value</span><span class="o">&gt;|&lt;</span><span class="p">(</span><span class="nx">nested</span><span class="p">)</span><span class="nx">list</span><span class="o">&gt;|&lt;</span><span class="nx">object</span><span class="o">&gt;</span>
<span class="p">}</span>
</pre></div>


<h2 id="45-json">4.5. json 格式说明</h2>
<h3 id="451">4.5.1. 输出二进制值的需求</h3>
<p>TensorFlow不区分非二进制和二进制值。所有的都是DT_STRING类型。tensor名中有_bytes后缀的表示有二进制值，每个值有着下面 编码二进制值中不同的编码。</p>
<h3 id="452-json">4.5.2. JSON映射</h3>
<p>RESTful APIs支持JSON的标准编码，使得不同系统间共享数据更简单。对于支持的类型，会按照下面的表进行一一对应编码。下表没列出的类型说明未支持。</p>
<table>
<thead>
<tr>
<th>TensorFlow数据类型</th>
<th>JSON值</th>
<th>JSON示例</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>DT_BOOL</td>
<td>true, false</td>
<td>true, false</td>
<td>-</td>
</tr>
<tr>
<td>DT_STRING</td>
<td>string</td>
<td>"Hello World!"</td>
<td>如果DT_STRING 表示的是二进制值（比如序列化的图片比特流），会以Base64编码。查看编码二进制值获取更多内容</td>
</tr>
<tr>
<td>DT_INT8, DT_UINT8, DT_INT16, DT_INT32, DT_UINT32, DT_INT64, DT_UINT64</td>
<td>number</td>
<td>1, -10, 0</td>
<td>JSON值为十进制整数</td>
</tr>
<tr>
<td>DT_FLOAT, DT_DOUBLE</td>
<td>number</td>
<td>1.1, -10.0, 0, NaN, Infinity</td>
<td>JSON值会是一个数字或者特殊标示值NaN和Infinity，查看JSON一致性获取更多内容。指数符号也是接受的。</td>
</tr>
<tr>
<td>### 4.5.3. 编码二进制值</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>JSON使用UTF-8编码。如果你输入了需要变成二进制的feature或者tensor值（比如图片比特流），你必须用Base64编码数据，并且将其放入有b64作为key的JSON对象，如下：</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="hlcode"><pre><span class="p">{</span> <span class="nt">&quot;b64&quot;</span><span class="p">:</span> <span class="err">&lt;base</span><span class="mi">64</span> <span class="err">encoded</span> <span class="err">string&gt;</span> <span class="p">}</span>
</pre></div>


<p>你可以将该值作为feature或者tensor的值，回复体也会以同样的形式编码。</p>
<p>一个有着image（二进制数据）和caption features 的分类请求如下：</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="nt">&quot;signature_name&quot;</span><span class="p">:</span> <span class="s2">&quot;classify_objects&quot;</span><span class="p">,</span>
  <span class="nt">&quot;examples&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;b64&quot;</span><span class="p">:</span> <span class="s2">&quot;aW1hZ2UgYnl0ZXM=&quot;</span> <span class="p">},</span>
      <span class="nt">&quot;caption&quot;</span><span class="p">:</span> <span class="s2">&quot;seaside&quot;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;b64&quot;</span><span class="p">:</span> <span class="s2">&quot;YXdlc29tZSBpbWFnZSBieXRlcw==&quot;</span> <span class="p">},</span>
      <span class="nt">&quot;caption&quot;</span><span class="p">:</span> <span class="s2">&quot;mountains&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<h3 id="454-json">4.5.4. JSON一致性</h3>
<p>很多feature或者tensor都是浮点型。除了有限的值外（e.g. 3.14, 1.0 等等），可以使用NaN或者无限值（Infinity 和-Infinity）。不幸的是JSON标准（RFC 7159）不识别这些值（即使JavaScript标准识别）。</p>
<p>REST API允许请求和回复体包含这些值。也就是说如下的请求是有效的：</p>
<div class="hlcode"><pre><span class="p">{</span>
  <span class="nt">&quot;example&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;sensor_readings&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">-3.14</span><span class="p">,</span> <span class="err">Nan</span><span class="p">,</span> <span class="err">Infinity</span> <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>遵循严格标准的JSON解析器会拒绝它并返回解析错误。为了准确地处理你的代码中的请求和回复，请使用支持这些标识的JSON解析器。</p>
<p>NaN, Infinity, -Infinity标识能被proto3、Python JSON模块和JavaScript语言识别。</p>
<p>略</p>
<h1 id="5">5. 部署离线设备</h1>
<p>部署到Android可参考 https://medium.com/@tobe_ml/all-tensorflow-models-can-be-embedded-into-mobile-devices-1932e80579e5</p>
<p>部署到iOS可参考 https://zhuanlan.zhihu.com/p/33715219</p>
<h1 id="7-simple_tensorflow_serving">7. [进阶] simple_tensorflow_serving 工具</h1>
<p>simple_tensorflow_serving 是一个TensorFlow Serving的封装，是机器学习模型的通用且易于使用的服务，使得模型的部署变得更加容易</p>
<p>参考：https://github.com/tobegit3hub/simple_tensorflow_serving</p>
<h1 id="8-savedmodel-cli-3">8. SavedModel CLI 命令概述<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">3</a></sup></h1>
<p>SavedModel CLI 在 SavedModel 中 MetaGraphDef 上支持以下两个命令：</p>
<p>show，显示在 SavedModel 中 MetaGraphDef 上的计算。<br />
run，在 MetaGraphDef 上运行计算。</p>
<h3 id="81-show">8.1. show 查看模型文件信息</h3>
<div class="hlcode"><pre><span class="cp"># 查看模型中所有Metagraph的tag</span>
<span class="n">saved_model_cli</span> <span class="n">show</span> <span class="o">--</span><span class="n">dir</span> <span class="s">&quot;/export_model&quot;</span>
<span class="o">&gt;&gt;&gt;</span>
<span class="n">The</span> <span class="n">given</span> <span class="n">SavedModel</span> <span class="n">contains</span> <span class="n">the</span> <span class="n">following</span> <span class="n">tag</span><span class="o">-</span><span class="n">sets</span><span class="o">:</span>
<span class="n">train</span>

<span class="n">saved_model_cli</span> <span class="n">show</span> <span class="o">--</span><span class="n">dir</span> <span class="s">&quot;/export_model&quot;</span>

<span class="cp"># 查看指定Metagraph的签名</span>
<span class="n">saved_model_cli</span> <span class="n">show</span> <span class="o">--</span><span class="n">dir</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">saved_model_dir</span> <span class="o">--</span><span class="n">tag_set</span> <span class="n">serve</span>


<span class="cp"># 查看模型的所有信息</span>

<span class="n">saved_model_cli</span> <span class="n">show</span> <span class="o">--</span><span class="n">dir</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">saved_model_dir</span> <span class="o">--</span><span class="n">all</span>
</pre></div>


<h3 id="82-run">8.2. run 运行</h3>
<p>调用 run 命令以运行图计算、传递输入，然后显示（并可选地保存）输出。语法如下：</p>
<div class="hlcode"><pre><span class="n">usage</span><span class="o">:</span> <span class="n">saved_model_cli</span> <span class="n">run</span> <span class="o">[-</span><span class="n">h</span><span class="o">]</span> <span class="o">--</span><span class="n">dir</span> <span class="n">DIR</span> <span class="o">--</span><span class="n">tag_set</span> <span class="n">TAG_SET</span> <span class="o">--</span><span class="n">signature_def</span>
                           <span class="n">SIGNATURE_DEF_KEY</span> <span class="o">[--</span><span class="n">inputs</span> <span class="n">INPUTS</span><span class="o">]</span>
                           <span class="o">[--</span><span class="n">input_exprs</span> <span class="n">INPUT_EXPRS</span><span class="o">]</span>
                           <span class="o">[--</span><span class="n">input_examples</span> <span class="n">INPUT_EXAMPLES</span><span class="o">]</span> <span class="o">[--</span><span class="n">outdir</span> <span class="n">OUTDIR</span><span class="o">]</span>
                           <span class="o">[--</span><span class="n">overwrite</span><span class="o">]</span> <span class="o">[--</span><span class="n">tf_debug</span><span class="o">]</span>
</pre></div>


<p>e<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">2</a></sup></p>
<h1 id="9">9. 参考文献</h1>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>Tensorflow官方 Serving a TensorFlow Model https://www.tensorflow.org/tfx/serving/serving_basic&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>https://github.com/tensorflow/tensorflow/blob/master/tensorflow/python/saved_model/README.md&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Tensorflow官方_保存和恢复 https://www.tensorflow.org/guide/saved_model#cli_to_inspect_and_execute_savedmodel&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>RESTful API : https://github.com/tensorflow/serving/blob/master/tensorflow_serving/g3doc/api_rest.md&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
</ol>
</div>
</div>
<div id="renote">
  <HR style=" FILTER: alpha (opacity = 100, finishopacity =0 , style= 3 )" width="80%" color=#987 cb 9 SIZE=3>
  <p>如果你觉得这篇文章对你有帮助，不妨请我喝杯咖啡，鼓励我创造更多!</p>
  <img src="/Wiki/static/images/pay.jpg" width="25%">
</div>

    </div>
    <div id="footer">
        <span>
            Copyright © 2020 zhang787jun.
            Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
        </span>
    </div>

    
</body>
<script>
    function changeImgurl(site_root_url) {
        var images = document.images;
        var site_root = site_root_url;
        for (i = 0, len = images.length; i < len; i++) {
            image = images[i];
            image_src = image.src;
            if (image_src.search("attach") >= 0) {
                re_image_src = image_src.slice(image_src.search("attach"));
                abs_image_src = (site_root.endsWith("/")) ? site_root + re_image_src : site_root + "/" +
                    re_image_src;
                image.src = abs_image_src;
            }
        }
    }
    var site_root_url = "/Wiki";
    changeImgurl(site_root_url);
    let isMathjaxConfig = false; // 防止重复调用Config，造成性能损耗
    const initMathjaxConfig = () => {
        if (!window.MathJax) {
            return;
        }
        window.MathJax.Hub.Config({
            showProcessingMessages: false, //关闭js加载过程信息
            messageStyle: "none", //不显示信息
            jax: ["input/TeX", "output/HTML-CSS"],
            tex2jax: {
                inlineMath: [["$", "$"], ["\\(", "\\)"]], //行内公式选择符
                displayMath: [["$$", "$$"], ["\\[", "\\]"]], //段内公式选择符
                skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //避开某些标签
            },
            "HTML-CSS": {
                availableFonts: ["STIX", "TeX"], //可选字体
                showMathMenu: false //关闭右击菜单显示
            }
        });
        isMathjaxConfig = true; //
    };
    if (isMathjaxConfig === false) {
        // 如果：没有配置MathJax
        initMathjaxConfig();
    };
</script>

</html>